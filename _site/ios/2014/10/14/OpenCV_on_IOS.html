<!DOCTYPE html>
<html>
<head>   
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

    <title>Rock's personal notebook - Blogging something deserved</title>
    <meta name="description" content="Your New Jekyll Site, Blogging about stuffs" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="/assets/css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />

    <!-- This is for syntax highlight -->
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css">
    <!-- Customisation  -->
    <link rel="stylesheet" type="text/css" href="/assets/css/main.css" />

</head>
<body class="home-template">

    
    <main class="content" role="main">

    <article class="post">
        <header class="post-header">
            <a id="blog-logo" href="http://rulerstorm.github.io">
                
                    <span class="blog-title">Rock's personal notebook</span>
                 
            </a>
        </header>
        
        <span class="post-meta">
        	<time datetime="2014-10-14">14 Oct 2014</time>
        	
        		on
	        	
	        	    ios
	        	
	        
       	</span>

        <h1 class="post-title">OpenCV_on_IOS</h1>

        <section class="post-content">
            <p>实话说，在对openCV一点不了解的情况下，直接搞ios版是走了很多弯路的。而且网上的教程都已经过时，新版的xcode用起来方便了很多。     </p>

<p>赶紧记录下正确路线：     </p>

<ol>
<li>下载openCV的IOS库：<strong><a href="http://opencv.org/downloads.html">我是链接</a></strong><br></li>
<li>下载得到的库直接拖到项目里面去即可（记得勾选<code>add to target</code>）<br></li>
<li>所有用到C++库的<strong><code>.m</code></strong>文件，改成<strong><code>.mm</code></strong>以支持编译C++语法<br></li>
<li>C++语法和OC语法混合后比较诡异，可以在<strong><code>.mm</code></strong>中<strong><code>using name space</code></strong>但是不可以定义全局函数。定义的“分类”也需要手动添加头文件。<br></li>
</ol>

<p>这样，openCV就算引入到xcode中了。（凡未提到的步骤一律不要，亲测！）     </p>

<p>最后，补充一下Mat与UIImage之间的转换代码，摘自官网：<strong><a href="http://docs.opencv.org/doc/tutorials/ios/image_manipulation/image_manipulation.html#opencviosimagemanipulation">我是链接</a>：</strong>     </p>

<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="lineno"> 1</span> <span class="c1">//这个是UIImage转Mat     </span>
<span class="lineno"> 2</span> <span class="p">-</span> <span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">)</span><span class="nf">cvMatFromUIImage:</span><span class="p">(</span><span class="bp">UIImage</span> <span class="o">*</span><span class="p">)</span><span class="nv">image</span>     
<span class="lineno"> 3</span> <span class="p">{</span>     
<span class="lineno"> 4</span>   <span class="n">CGColorSpaceRef</span> <span class="n">colorSpace</span> <span class="o">=</span> <span class="n">CGImageGetColorSpace</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="bp">CGImage</span><span class="p">);</span>     
<span class="lineno"> 5</span>   <span class="n">CGFloat</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>     
<span class="lineno"> 6</span>   <span class="n">CGFloat</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>     
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span>   <span class="n">cv</span><span class="o">::</span><span class="n">Mat</span> <span class="n">cvMat</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">CV_8UC4</span><span class="p">);</span> <span class="c1">// 8 bits per component, 4 channels (color channels + alpha)     </span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span>   <span class="n">CGContextRef</span> <span class="n">contextRef</span> <span class="o">=</span> <span class="n">CGBitmapContextCreate</span><span class="p">(</span><span class="n">cvMat</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>                 <span class="c1">// Pointer to  data     </span>
<span class="lineno">11</span>                                                  <span class="n">cols</span><span class="p">,</span>                       <span class="c1">// Width of bitmap     </span>
<span class="lineno">12</span>                                                  <span class="n">rows</span><span class="p">,</span>                       <span class="c1">// Height of bitmap     </span>
<span class="lineno">13</span>                                                  <span class="mi">8</span><span class="p">,</span>                          <span class="c1">// Bits per component     </span>
<span class="lineno">14</span>                                                  <span class="n">cvMat</span><span class="p">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>              <span class="c1">// Bytes per row     </span>
<span class="lineno">15</span>                                                  <span class="n">colorSpace</span><span class="p">,</span>                 <span class="c1">// Colorspace     </span>
<span class="lineno">16</span>                                                  <span class="n">kCGImageAlphaNoneSkipLast</span> <span class="o">|</span>     
<span class="lineno">17</span>                                                  <span class="n">kCGBitmapByteOrderDefault</span><span class="p">);</span> <span class="c1">// Bitmap info flags     </span>
<span class="lineno">18</span> 
<span class="lineno">19</span>   <span class="n">CGContextDrawImage</span><span class="p">(</span><span class="n">contextRef</span><span class="p">,</span> <span class="n">CGRectMake</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">),</span> <span class="n">image</span><span class="p">.</span><span class="bp">CGImage</span><span class="p">);</span>     
<span class="lineno">20</span>   <span class="n">CGContextRelease</span><span class="p">(</span><span class="n">contextRef</span><span class="p">);</span>     
<span class="lineno">21</span> 
<span class="lineno">22</span>   <span class="k">return</span> <span class="n">cvMat</span><span class="p">;</span>     
<span class="lineno">23</span> <span class="p">}</span>     
<span class="lineno">24</span> 
<span class="lineno">25</span> 
<span class="lineno">26</span> 
<span class="lineno">27</span> 
<span class="lineno">28</span> <span class="c1">//这个是Mat转回UIImage     </span>
<span class="lineno">29</span> <span class="p">-(</span><span class="bp">UIImage</span> <span class="o">*</span><span class="p">)</span><span class="nf">UIImageFromCVMat:</span><span class="p">(</span><span class="n">cv</span><span class="o">::</span><span class="n">Mat</span><span class="p">)</span><span class="nv">cvMat</span>     
<span class="lineno">30</span> <span class="p">{</span>     
<span class="lineno">31</span>     <span class="bp">NSData</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSData</span> <span class="nl">dataWithBytes</span><span class="p">:</span><span class="n">cvMat</span><span class="p">.</span><span class="n">data</span> <span class="nl">length</span><span class="p">:</span><span class="n">cvMat</span><span class="p">.</span><span class="n">elemSize</span><span class="p">()</span><span class="o">*</span><span class="n">cvMat</span><span class="p">.</span><span class="n">total</span><span class="p">()];</span>     
<span class="lineno">32</span>     <span class="n">CGColorSpaceRef</span> <span class="n">colorSpace</span><span class="p">;</span>     
<span class="lineno">33</span>     
<span class="lineno">34</span>     <span class="k">if</span> <span class="p">(</span><span class="n">cvMat</span><span class="p">.</span><span class="n">elemSize</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>     
<span class="lineno">35</span>         <span class="n">colorSpace</span> <span class="o">=</span> <span class="n">CGColorSpaceCreateDeviceGray</span><span class="p">();</span>     
<span class="lineno">36</span>     <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>     
<span class="lineno">37</span>         <span class="n">colorSpace</span> <span class="o">=</span> <span class="n">CGColorSpaceCreateDeviceRGB</span><span class="p">();</span>     
<span class="lineno">38</span>     <span class="p">}</span>     
<span class="lineno">39</span>     
<span class="lineno">40</span>     <span class="n">CGDataProviderRef</span> <span class="n">provider</span> <span class="o">=</span> <span class="n">CGDataProviderCreateWithCFData</span><span class="p">((</span><span class="k">__bridge</span> <span class="n">CFDataRef</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>     
<span class="lineno">41</span>     
<span class="lineno">42</span>     <span class="c1">// Creating CGImage from cv::Mat     </span>
<span class="lineno">43</span>     <span class="n">CGImageRef</span> <span class="n">imageRef</span> <span class="o">=</span> <span class="n">CGImageCreate</span><span class="p">(</span><span class="n">cvMat</span><span class="p">.</span><span class="n">cols</span><span class="p">,</span>                                 <span class="c1">//width     </span>
<span class="lineno">44</span>                                         <span class="n">cvMat</span><span class="p">.</span><span class="n">rows</span><span class="p">,</span>                                 <span class="c1">//height     </span>
<span class="lineno">45</span>                                         <span class="mi">8</span><span class="p">,</span>                                          <span class="c1">//bits per component     </span>
<span class="lineno">46</span>                                         <span class="mi">8</span> <span class="o">*</span> <span class="n">cvMat</span><span class="p">.</span><span class="n">elemSize</span><span class="p">(),</span>                       <span class="c1">//bits per pixel     </span>
<span class="lineno">47</span>                                         <span class="n">cvMat</span><span class="p">.</span><span class="n">step</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>                            <span class="c1">//bytesPerRow     </span>
<span class="lineno">48</span>                                         <span class="n">colorSpace</span><span class="p">,</span>                                 <span class="c1">//colorspace     </span>
<span class="lineno">49</span>                                         <span class="n">kCGImageAlphaNone</span><span class="o">|</span><span class="n">kCGBitmapByteOrderDefault</span><span class="p">,</span><span class="c1">// bitmap info     </span>
<span class="lineno">50</span>                                         <span class="n">provider</span><span class="p">,</span>                                   <span class="c1">//CGDataProviderRef     </span>
<span class="lineno">51</span>                                         <span class="nb">NULL</span><span class="p">,</span>                                       <span class="c1">//decode     </span>
<span class="lineno">52</span>                                         <span class="nb">false</span><span class="p">,</span>                                      <span class="c1">//should interpolate     </span>
<span class="lineno">53</span>                                         <span class="n">kCGRenderingIntentDefault</span>                   <span class="c1">//intent     </span>
<span class="lineno">54</span>                                         <span class="p">);</span>     
<span class="lineno">55</span>     
<span class="lineno">56</span>     
<span class="lineno">57</span>     <span class="c1">// Getting UIImage from CGImage     </span>
<span class="lineno">58</span>     <span class="bp">UIImage</span> <span class="o">*</span><span class="n">finalImage</span> <span class="o">=</span> <span class="p">[</span><span class="bp">UIImage</span> <span class="nl">imageWithCGImage</span><span class="p">:</span><span class="n">imageRef</span><span class="p">];</span>     
<span class="lineno">59</span>     <span class="n">CGImageRelease</span><span class="p">(</span><span class="n">imageRef</span><span class="p">);</span>     
<span class="lineno">60</span>     <span class="n">CGDataProviderRelease</span><span class="p">(</span><span class="n">provider</span><span class="p">);</span>     
<span class="lineno">61</span>     <span class="n">CGColorSpaceRelease</span><span class="p">(</span><span class="n">colorSpace</span><span class="p">);</span>     
<span class="lineno">62</span>     
<span class="lineno">63</span>     <span class="k">return</span> <span class="n">finalImage</span><span class="p">;</span>     
<span class="lineno">64</span> <span class="p">}</span></code></pre></div>
     

<p>最后，附上我折腾一晚上的，我的第一个ios应用，<strong><a href="https://github.com/rulerstorm/HelloOpenCV">GitHub</a></strong>     </p>

        </section>

        

        <footer class="post-footer">
        	<!-- If we want to display author's name and bio -->
            
                <section class="author">
                	<header> <a href=""> <img class="profile" src="/assets/images/profile.png" alt="Author's profile picture"></a></header>
                	<article>
                		<!-- Author Name -->
                    	<h4> Rock Lu </h4>
                    	<!-- Author Bio -->
                    	<p> 
                    		<!-- Here goes the author description. You might want to place some links too in here -->
                    	    A newbie coder    <br>
                            Contact: &nbsp luleruler@gmail.com

                        </p>
                    </article>
                </section>                
            
        	
        </footer>

    </article>

</main>


    <footer class="site-footer">
        <a class="subscribe icon-feed" href="rss.xml"><span class="tooltip">Subscribe!</span></a>
        <div class="inner">
             <section class="copyright">All content copyright <a href="">Rock's personal notebook</a> &copy;  &bull; All rights reserved.</section>
             <section class="poweredby">Made with Jekyll using <a href="http://github.com/rosario/kasper">Kasper theme</a></section>
        </div>
    </footer>

    
    <script type="text/javascript" src="/assets/js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="/assets/js/index.js"></script>

    <!-- Google Analytics Tracking code -->

</body>
</html>
